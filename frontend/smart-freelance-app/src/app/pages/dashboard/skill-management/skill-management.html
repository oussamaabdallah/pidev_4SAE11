<div class="skill-management-container">
  <!-- Error Banner -->
  <div *ngIf="errorMessage" class="error-banner">
    {{ errorMessage }}
  </div>

  <!-- Header Section -->
  <div class="header">
    <h2>My Skills</h2>
    <div class="header-actions">
      <button class="btn-outline" (click)="openHistoryModal()">
        <span>üìã</span>
        <span>Test History</span>
      </button>
      <button class="btn-primary" (click)="openAddModal()">
        <span>+</span>
        <span>Add Skill</span>
      </button>
    </div>
  </div>

  <!-- Skills Grouped by Domain -->
  <div class="skills-container">
    <div class="domain-section" *ngFor="let domain of skillDomains">
      <div class="skills-grid">
        <div class="skill-card" *ngFor="let skill of getSkillsByDomain(domain)"
             [attr.data-color]="getSkillColor(skill.name)">

          <!-- Ambient background glow -->
          <div class="card-glow"></div>

          <!-- Delete button ‚Äî top-right corner -->
          <button class="delete-btn" (click)="confirmDelete(skill.id!)" title="Delete Skill">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
              <path d="M2 4h12M5.333 4V2.667a1.333 1.333 0 011.334-1.334h2.666a1.333 1.333 0 011.334 1.334V4m2 0v9.333a1.333 1.333 0 01-1.334 1.334H4.667a1.333 1.333 0 01-1.334-1.334V4h9.334z"
                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>

          <!-- Avatar circle -->
          <div class="card-avatar">
            {{ skill.name.charAt(0) | uppercase }}
          </div>

          <!-- Name + domain chip + verified chip -->
          <div class="card-body">
            <h4 class="skill-name">{{ skill.name }}</h4>
            <div class="skill-tags">
              <span class="domain-chip">{{ skill.domain }}</span>
              <span class="verified-chip" *ngIf="skill.verified">
                <svg width="9" height="9" viewBox="0 0 12 12" fill="none">
                  <path d="M10 3L4.5 8.5L2 6" stroke="currentColor" stroke-width="2.2"
                    stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Verified
              </span>
            </div>
          </div>

          <!-- Score bar (if evaluated) -->
          <div class="score-section" *ngIf="skill.score !== undefined">
            <div class="score-row">
              <span class="score-label">Score</span>
              <span class="score-pct">{{ ((skill.score / 5) * 100) | number:'1.0-0' }}%</span>
            </div>
            <div class="score-track">
              <div class="score-fill" [style.width.%]="(skill.score / 5) * 100"></div>
            </div>
          </div>

          <!-- Footer action -->
          <div class="card-footer">
            <button *ngIf="!skill.verified" class="verify-btn" (click)="verifySkill(skill.id!)">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2l1.9 5.8L20 9.2l-5.3 3.9 1.9 5.8L12 15l-4.6 3.9 1.9-5.8L4 9.2l6.1-1.4z"/>
              </svg>
              Verify with Test
            </button>
            <div *ngIf="skill.verified" class="verified-badge-footer">
              <svg width="13" height="13" viewBox="0 0 16 16" fill="none">
                <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5"/>
                <path d="M5 8l2 2 4-4" stroke="currentColor" stroke-width="1.5"
                  stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Skill Verified
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="skills.length === 0" class="empty-state">
      <div class="empty-icon">üß©</div>
      <h3>No skills added yet</h3>
      <p>Add your skills to get matched with projects.</p>
      <button class="btn-secondary" (click)="openAddModal()">Add Your First Skill</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       Delete Confirmation Modal
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="modal" *ngIf="showDeleteConfirm" (click)="cancelDelete()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>üóëÔ∏è Confirm Deletion</h3>
      <div class="form-body">
        <p style="margin: 0; color: #6B7280; font-size: 16px; line-height: 1.625;">
          Are you sure you want to delete this skill? This action will remove it from your profile and cannot be undone.
        </p>
      </div>
      <div class="modal-actions">
        <button (click)="cancelDelete()">Cancel</button>
        <button (click)="deleteSkill()" class="btn-danger">Delete Skill</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       Add Skill Modal
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="modal" *ngIf="showAddModal" (click)="showAddModal = false">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>‚ûï Add New Skill</h3>
      <div class="form-body">
        <div class="form-group">
          <label for="skillName">Skill Name <span class="req">*</span></label>
          <input
            id="skillName"
            [(ngModel)]="newSkillName"
            placeholder="e.g. Java, React, Python"
            [class.input-invalid]="skillFormErrors['name']"
            (ngModelChange)="skillFormErrors['name'] = ''"
            (keyup.enter)="newSkillDomain ? addSkill() : null"
            maxlength="50"
          />
          <span class="field-err-msg" *ngIf="skillFormErrors['name']">{{ skillFormErrors['name'] }}</span>
          <span class="field-hint" *ngIf="!skillFormErrors['name']">Letters, numbers, spaces and . + # - / ( ) ‚Äî max 50 chars</span>
        </div>
        <div class="form-group">
          <label for="skillDomain">Domain <span class="req">*</span></label>
          <input
            id="skillDomain"
            [(ngModel)]="newSkillDomain"
            placeholder="e.g. Backend, Frontend, DevOps"
            [class.input-invalid]="skillFormErrors['domain']"
            (ngModelChange)="skillFormErrors['domain'] = ''"
            (keyup.enter)="newSkillName ? addSkill() : null"
            maxlength="30"
          />
          <span class="field-err-msg" *ngIf="skillFormErrors['domain']">{{ skillFormErrors['domain'] }}</span>
          <span class="field-hint" *ngIf="!skillFormErrors['domain']">e.g. Backend, Frontend, DevOps ‚Äî max 30 chars</span>
        </div>
      </div>
      <div class="modal-actions">
        <button (click)="showAddModal = false">Cancel</button>
        <button (click)="addSkill()" class="btn-primary">Add Skill</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       AI Test Modal
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="modal" *ngIf="showTestModal" (click)="!isGeneratingTest && !currentTest ? closeTestModal() : null">
    <div class="modal-content test-content" (click)="$event.stopPropagation()">

      <!-- ‚îÄ‚îÄ Loading State ‚îÄ‚îÄ -->
      <div *ngIf="isGeneratingTest" class="loading-state">
        <div class="spinner"></div>
        <h3>Generating Your Test</h3>
        <p>Please wait, generating questions...</p>
      </div>

      <!-- ‚îÄ‚îÄ Question State ‚îÄ‚îÄ -->
      <div *ngIf="!isGeneratingTest && currentTest && !testResult">
        <h3>üìù {{ currentTest.title }}</h3>

        <div class="question-box">
          <div class="progress-indicator">
            Question {{ currentQuestionIndex + 1 }} of {{ currentTest.questions.length }}
            <div class="progress-bar">
              <div class="progress-fill"
                [style.width.%]="((currentQuestionIndex + 1) / currentTest.questions.length) * 100">
              </div>
            </div>
          </div>

          <h4>{{ currentTest.questions[currentQuestionIndex].questionText }}</h4>

          <div class="options">
            <label
              *ngFor="let option of currentTest.questions[currentQuestionIndex].options.split('###')"
              [class.correct]="isAnswerSubmitted && option.trim() === currentTest.questions[currentQuestionIndex].correctOption"
              [class.wrong]="isAnswerSubmitted && option.trim() === selectedOption && option.trim() !== currentTest.questions[currentQuestionIndex].correctOption"
            >
              <input
                type="radio"
                name="option"
                [value]="option.trim()"
                [(ngModel)]="selectedOption"
                [disabled]="isAnswerSubmitted"
              >
              {{ option.trim() }}
            </label>
          </div>

          <div *ngIf="isAnswerSubmitted" class="feedback">
            <p *ngIf="isAnswerCorrect" class="success">
              ‚úì Correct! Well done.
            </p>
            <p *ngIf="!isAnswerCorrect" class="error">
              ‚úó Incorrect. The correct answer is: <strong>{{ currentTest.questions[currentQuestionIndex].correctOption }}</strong>
            </p>
          </div>
        </div>

        <div class="modal-actions">
          <button (click)="closeTestModal()">Quit Test</button>
          <button
            *ngIf="!isAnswerSubmitted"
            (click)="submitAnswer()"
            [disabled]="!selectedOption"
            class="btn-primary"
          >
            Submit Answer
          </button>
          <button
            *ngIf="isAnswerSubmitted"
            (click)="nextQuestion()"
            class="btn-primary"
          >
            {{ currentQuestionIndex < currentTest.questions.length - 1 ? 'Next Question ‚Üí' : 'Finish Test' }}
          </button>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Results State ‚îÄ‚îÄ -->
      <div *ngIf="testResult" class="result-box">
        <h3>üéâ Test Complete!</h3>
        <div class="score-display" [class.passed]="testResult.passed" [class.failed]="!testResult.passed">
          <div class="score-circle">
            {{ 100 * testResult.score / (currentTest?.questions?.length || 1) }}%
          </div>
          <p class="status-text">{{ testResult.passed ? '‚úì PASSED' : '‚úó FAILED' }}</p>
        </div>
        <p class="result-detail" *ngIf="testResult.testResult">{{ testResult.testResult }}</p>
        <div class="result-actions">
          <button class="btn-outline" (click)="goToHistory()">üìã See Test History</button>
          <button class="btn-primary" (click)="closeTestModal()">Done</button>
        </div>
      </div>

    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       Test History Modal
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="modal" *ngIf="showHistoryModal" (click)="closeHistoryModal()">
    <div class="modal-content history-content" (click)="$event.stopPropagation()">
      <h3>üìã My Test History</h3>

      <!-- Loading -->
      <div *ngIf="isLoadingHistory" class="loading-state">
        <div class="spinner"></div>
        <h3>Loading History</h3>
        <p>Fetching your past test results...</p>
      </div>

      <!-- History List -->
      <div *ngIf="!isLoadingHistory" class="history-list">

        <!-- Empty state -->
        <div *ngIf="evaluationHistory.length === 0" class="history-empty">
          <div class="history-empty-icon">üì≠</div>
          <p>No tests taken yet. Click <strong>Verify Skill</strong> on any skill card to start your first test.</p>
        </div>

        <!-- History items -->
        <div
          *ngFor="let evaluation of evaluationHistory"
          class="history-item"
        >
          <div class="history-item-left">
            <div class="history-skill-icon">
              {{ (evaluation.skill?.name || '?').charAt(0).toUpperCase() }}
            </div>
            <div class="history-item-info">
              <div class="history-skill-name">{{ evaluation.skill?.name || 'Unknown Skill' }}</div>
              <div class="history-date">{{ formatDate(evaluation.evaluatedAt) }}</div>
              <div class="history-result-text" *ngIf="evaluation.testResult">{{ evaluation.testResult }}</div>
            </div>
          </div>
          <div class="history-item-right">
            <div class="history-score">{{ 100 * evaluation.score / 5 }}%</div>
            <span class="history-badge" [class.passed]="evaluation.passed" [class.failed]="!evaluation.passed">
              {{ evaluation.passed ? 'PASSED' : 'FAILED' }}
            </span>
          </div>
        </div>

      </div>

      <div class="modal-actions">
        <button class="btn-primary" (click)="closeHistoryModal()">Close</button>
      </div>
    </div>
  </div>

</div>
