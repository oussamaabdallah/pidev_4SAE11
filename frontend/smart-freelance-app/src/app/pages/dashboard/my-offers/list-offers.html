<div class="offers-container">
  <div class="offers-header">
    <h2 class="section-title">My Offers</h2>
    <a routerLink="/dashboard/my-offers/add" class="btn btn--add-offer">+ Add Offer</a>
  </div>

  <!-- Recherche dynamique (dÃ¨s le 1er caractÃ¨re, requÃªtes JSON backend) -->
  <section class="search-section">
    <div class="search-row">
      <input
        type="text"
        class="search-input"
        placeholder="Search by title, description, tagsâ€¦"
        [(ngModel)]="keyword"
        (input)="onKeywordInput()"
      />
    </div>

    <!-- Filtres avancÃ©s cumulables -->
    <div class="filters-panel">
      <div class="filter-row">
        <input type="text" class="filter-input" placeholder="Category" [(ngModel)]="category" />
        <select class="filter-select" [(ngModel)]="offerStatus">
          <option value="">All statuses</option>
          <option value="DRAFT">DRAFT</option>
          <option value="AVAILABLE">AVAILABLE</option>
          <option value="IN_PROGRESS">IN_PROGRESS</option>
          <option value="ACCEPTED">ACCEPTED</option>
          <option value="COMPLETED">COMPLETED</option>
          <option value="EXPIRED">EXPIRED</option>
          <option value="CLOSED">CLOSED</option>
        </select>
        <input type="date" class="filter-date" placeholder="From" [(ngModel)]="createdAtFrom" />
        <input type="date" class="filter-date" placeholder="To" [(ngModel)]="createdAtTo" />
        <input type="number" class="filter-number" placeholder="Min price" min="0" step="0.01" [(ngModel)]="minPrice" />
        <input type="number" class="filter-number" placeholder="Max price" min="0" step="0.01" [(ngModel)]="maxPrice" />
        <button type="button" class="btn btn--apply" (click)="applyFilters()">Apply filters</button>
        <button type="button" class="btn btn--clear" (click)="clearFilters()">Clear</button>
      </div>
    </div>
  </section>

  <div class="toolbar">
    <span class="toolbar-count">{{ totalElements }} offer(s)</span>
    <button type="button" class="btn-refresh" (click)="loadOffers()" [disabled]="loading">
      {{ loading ? 'Loadingâ€¦' : 'Refresh' }}
    </button>
  </div>

  <div class="loading-state" *ngIf="loading">
    <p>Loading offers...</p>
  </div>

  <div class="error-state" *ngIf="errorMessage && !loading">
    <p class="error">{{ errorMessage }}</p>
    <button (click)="loadOffers()" class="btn btn--retry">Try Again</button>
  </div>

  <div class="offers-grid" *ngIf="!loading && !errorMessage && offers.length > 0">
    <div class="offer-card" *ngFor="let offer of offers">
      <div class="offer-content">
        <div class="offer-header">
          <h3 class="offer-title">{{ offer.title }}</h3>
          <span
            class="offer-status"
            [ngClass]="{
              'status-draft': offer.offerStatus === 'DRAFT',
              'status-available': offer.offerStatus === 'AVAILABLE',
              'status-in-progress': offer.offerStatus === 'IN_PROGRESS',
              'status-accepted': offer.offerStatus === 'ACCEPTED',
              'status-closed': offer.offerStatus === 'CLOSED' || offer.offerStatus === 'EXPIRED'
            }"
          >
            {{ offer.offerStatus }}
          </span>
        </div>
        <span class="offer-domain">{{ offer.domain }}</span>
        <p class="offer-description">{{ (offer.description | slice:0:120) }}{{ ((offer.description || '').length) > 120 ? 'â€¦' : '' }}</p>
        <div class="offer-meta">
          <span class="price">{{ offer.price | number:'1.2-2' }} ({{ offer.durationType }})</span>
          <span *ngIf="offer.pendingApplicationsCount != null" class="applications">{{ offer.pendingApplicationsCount }} pending</span>
        </div>
        <div class="offer-actions">
          <a [routerLink]="['/dashboard/my-offers', offer.id, 'show']" class="btn btn--info">View</a>
          <a *ngIf="offer.offerStatus === 'DRAFT'" [routerLink]="['/dashboard/my-offers', offer.id, 'edit']" class="btn btn--update">Edit</a>
          <button *ngIf="offer.offerStatus === 'DRAFT'" (click)="openPublishModal(offer)" class="btn btn--publish">Publish</button>
          <button (click)="openDeleteModal(offer)" class="btn btn--delete">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  @if (totalPages > 1 && !loading) {
    <div class="pagination">
      <button type="button" [disabled]="currentPage === 0" (click)="goToPage(currentPage - 1)">Previous</button>
      <span class="page-info">Page {{ currentPage + 1 }} / {{ totalPages }}</span>
      <button type="button" [disabled]="currentPage >= totalPages - 1" (click)="goToPage(currentPage + 1)">Next</button>
    </div>
  }

  <div class="empty-state" *ngIf="!loading && !errorMessage && offers.length === 0">
<<<<<<< HEAD
    <p>No offers match your filters.</p>
    <div class="empty-actions">
      <button type="button" class="btn btn--clear" (click)="clearFilters()">Clear filters</button>
      <a routerLink="/dashboard/my-offers/add" class="btn btn--add-offer">Create an offer</a>
    </div>
=======
    <span class="empty-icon">ðŸ“‹</span>
    <p>No offers yet. Create your first offer to get started!</p>
    <a routerLink="/dashboard/my-offers/add" class="btn btn--add-offer">Create your first offer</a>
>>>>>>> 3d77214c3395a206df006b98c337604ca8cfb723
  </div>

  <!-- Statistiques (en bas de page) â€“ calcul backend, affichage uniquement -->
  <section class="stats-section">
    <header class="stats-header">
      <h3 class="stats-title">Performance overview</h3>
      <p class="stats-subtitle">Key metrics from your offers and applications</p>
    </header>
    @if (statsLoading) {
      <div class="stats-loading-state">
        <span class="stats-spinner"></span>
        <p class="stats-loading-text">Loading statisticsâ€¦</p>
      </div>
    } @else {
      <div class="stats-grid">
        @if (statsByStatus) {
          <article class="stat-card stat-card--status">
            <div class="stat-card__header">
              <span class="stat-card__icon stat-card__icon--status" aria-hidden="true"></span>
              <h4 class="stat-card__title">Offers by status</h4>
            </div>
            <p class="stat-card__total">{{ totalOffersByStatus() }} total</p>
            <div class="status-badges">
              @for (entry of (statsByStatus | keyvalue); track entry.key) {
                @if (entry.value > 0) {
                  <span class="badge" [ngClass]="'badge--' + statusSlug(entry.key)">{{ entry.key }}: {{ entry.value }}</span>
                }
              }
            </div>
          </article>
        }
        @if (acceptanceRate) {
          <article class="stat-card stat-card--rate">
            <div class="stat-card__header">
              <span class="stat-card__icon stat-card__icon--rate" aria-hidden="true"></span>
              <h4 class="stat-card__title">Acceptance rate</h4>
            </div>
            <p class="stat-card__kpi rate-value">{{ formatRate(acceptanceRate.rate) }}</p>
            <div class="rate-bar" [style.--rate]="(acceptanceRate.rate * 100) + '%'">
              <span class="rate-bar__fill"></span>
            </div>
            <p class="stat-card__detail rate-detail">{{ acceptanceRate.acceptedCount }} accepted / {{ acceptanceRate.totalApplications }} applications</p>
          </article>
        }
        @if (monthlyEvolution) {
          <article class="stat-card stat-card--evolution">
            <div class="stat-card__header">
              <span class="stat-card__icon stat-card__icon--chart" aria-hidden="true"></span>
              <h4 class="stat-card__title">Monthly evolution</h4>
              <div class="year-select">
                <label for="stats-year" class="year-select__label">Year</label>
                <select id="stats-year" class="year-select__input" [(ngModel)]="selectedYear" (ngModelChange)="refreshMonthlyEvolution()">
                  @for (y of yearOptions; track y) {
                    <option [value]="y">{{ y }}</option>
                  }
                </select>
              </div>
            </div>
            <div class="chart chart--bars">
              <div class="chart__bars">
                @for (m of monthlyEvolution.months; track m.month) {
                  <div class="chart__bar-wrap" [title]="monthName(m.month) + ': ' + m.count">
                    <span class="chart__bar" [style.--h]="(maxMonthCount ? (m.count / maxMonthCount) : 0) * 100"></span>
                  </div>
                }
              </div>
              <div class="chart__labels">
                @for (m of monthlyEvolution.months; track m.month) {
                  <span class="chart__label">{{ monthName(m.month) }}</span>
                }
              </div>
              <div class="chart__values">
                @for (m of monthlyEvolution.months; track m.month) {
                  <span class="chart__value">{{ m.count }}</span>
                }
              </div>
            </div>
          </article>
        }
      </div>
    }
  </section>

  @if (offerToDelete) {
    <div class="modal-overlay" (click)="closeDeleteModal()">
      <div class="modal modal--confirm" (click)="$event.stopPropagation()">
        <h3>Delete offer</h3>
        <p class="modal-message">
          Are you sure you want to delete <strong>{{ offerToDelete.title }}</strong>?
        </p>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeDeleteModal()" [disabled]="deleting">Cancel</button>
          <button type="button" class="btn-danger" (click)="doDelete()" [disabled]="deleting">
            {{ deleting ? 'Deletingâ€¦' : 'Delete' }}
          </button>
        </div>
      </div>
    </div>
  }

  @if (offerToPublish) {
    <div class="modal-overlay" (click)="closePublishModal()">
      <div class="modal modal--confirm" (click)="$event.stopPropagation()">
        <h3>Publish offer</h3>
        <p class="modal-message">
          Publish <strong>{{ offerToPublish.title }}</strong> so clients can see and apply?
        </p>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closePublishModal()" [disabled]="publishing">Cancel</button>
          <button type="button" class="btn-primary" (click)="doPublish()" [disabled]="publishing">
            {{ publishing ? 'Publishingâ€¦' : 'Publish' }}
          </button>
        </div>
      </div>
    </div>
  }
</div>
