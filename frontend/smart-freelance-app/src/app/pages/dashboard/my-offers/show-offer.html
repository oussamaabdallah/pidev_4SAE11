<div class="show-offer-page" *ngIf="offer">
  <div class="back-row">
    <a routerLink="/dashboard/my-offers" class="btn-back">Back to my offers</a>
  </div>
  <div class="offer-detail card">
    <div class="offer-header">
      <h1>{{ offer.title }}</h1>
      <span class="status-badge">{{ offer.offerStatus }}</span>
    </div>
    <p class="domain">{{ offer.domain }}</p>
    <p class="description">{{ offer.description }}</p>
    <div class="meta">
      <span class="price">{{ offer.price | number:'1.2-2' }} ({{ offer.durationType }})</span>
      <span *ngIf="offer.deadline">Deadline: {{ offer.deadline }}</span>
      <span *ngIf="offer.pendingApplicationsCount != null">{{ offer.pendingApplicationsCount }} pending</span>
    </div>
  </div>

  <!-- Traduction multilingue (Google Translate – FR / EN / AR) -->
  <section class="translate-section card">
    <h2 class="translate-section__title">
      <span class="translate-section__icon" aria-hidden="true"></span>
      Translate this offer
    </h2>
    <p class="translate-section__subtitle">Get title and description in another language (FR / EN / AR).</p>
    <div class="translate-section__actions">
      <button
        type="button"
        class="translate-lang-btn"
        [class.translate-lang-btn--active]="selectedTranslateLang === 'fr'"
        (click)="selectedTranslateLang = 'fr'"
      >
        Français
      </button>
      <button
        type="button"
        class="translate-lang-btn"
        [class.translate-lang-btn--active]="selectedTranslateLang === 'en'"
        (click)="selectedTranslateLang = 'en'"
      >
        English
      </button>
      <button
        type="button"
        class="translate-lang-btn"
        [class.translate-lang-btn--active]="selectedTranslateLang === 'ar'"
        (click)="selectedTranslateLang = 'ar'"
      >
        العربية
      </button>
      <button
        type="button"
        class="translate-run-btn"
        (click)="runTranslate()"
        [disabled]="translating"
      >
        {{ translating ? 'Translating…' : 'Translate' }}
      </button>
    </div>
    @if (translateError) {
      <p class="translate-section__error" role="alert">{{ translateError }}</p>
    }
    @if (translatedResult) {
      <div class="translate-result" [class.translate-result--rtl]="selectedTranslateLang === 'ar'">
        <h3 class="translate-result__title">{{ translatedResult.title }}</h3>
        <p class="translate-result__description">{{ translatedResult.description }}</p>
        <p class="translate-result__meta">Translated to {{ translateLangLabel(selectedTranslateLang) }}</p>
      </div>
    }
  </section>

  <!-- Q&A : questions des clients (répondre ici) -->
  <section class="qa-freelancer-section card">
    <h2 class="qa-freelancer-section__title">Questions from clients</h2>
    <p class="qa-freelancer-section__subtitle">Answer client questions before they apply.</p>
    @if (loadingQuestions) {
      <p class="qa-freelancer-section__loading">Loading...</p>
    } @else if (offerQuestions.length === 0) {
      <p class="qa-freelancer-section__empty">No questions yet.</p>
    } @else {
      <div class="qa-freelancer-list">
        @for (q of offerQuestions; track q.id) {
          <div class="qa-freelancer-item" [class.qa-freelancer-item--answered]="q.answered">
            <p class="qa-freelancer-item__q">{{ q.questionText }}</p>
            <span class="qa-freelancer-item__date">Asked {{ formatDate(q.askedAt) }}</span>
            @if (q.answered && q.answerText) {
              <p class="qa-freelancer-item__a"><strong>Your answer:</strong> {{ q.answerText }}</p>
            } @else {
              <div class="qa-freelancer-item__answer-form">
                <textarea
                  [id]="'answer-' + q.id"
                  placeholder="Write your answer..."
                  [(ngModel)]="answerTexts[q.id]"
                  name="answer-{{ q.id }}"
                  rows="2"
                ></textarea>
                <button type="button" class="btn-answer" (click)="submitAnswer(q.id)" [disabled]="answeringId === q.id || !(answerTexts[q.id] || '').trim()">
                  {{ answeringId === q.id ? 'Sending...' : 'Reply' }}
                </button>
              </div>
            }
          </div>
        }
      </div>
    }
  </section>

  <div class="applications-section">
    <h2>Applications</h2>
    <p class="loading-msg" *ngIf="loadingApps">Loading applications...</p>
    <p class="empty-msg" *ngIf="!loadingApps && applications.length === 0">No applications yet.</p>
    <div class="applications-list" *ngIf="!loadingApps && applications.length > 0">
      <div class="app-card" *ngFor="let app of applications" [class.app-card--unread]="app.isRead === false">
        <div class="app-main">
          @if (app.isRead === false) {
            <span class="app-badge-unread">New</span>
          }
          <p class="app-message">{{ app.message }}</p>
          <p class="app-meta">Proposed budget: {{ app.proposedBudget | number:'1.2-2' }} - Applied {{ formatDate(app.appliedAt) }}</p>
          @if (app.estimatedDuration) {
            <p class="app-meta">Duration: {{ app.estimatedDuration }} day(s)</p>
          }
          @if (app.portfolioUrl) {
            <p class="app-meta">Portfolio: <a [href]="app.portfolioUrl" target="_blank" rel="noopener">{{ app.portfolioUrl }}</a></p>
          }
          @if (app.status === 'REJECTED' && app.rejectionReason) {
            <p class="app-rejection" role="alert"><strong>Reason:</strong> {{ app.rejectionReason }}</p>
          }
          <span class="app-status" [ngClass]="'app-status--' + app.status">{{ app.status }}</span>
        </div>
        <div class="app-actions" *ngIf="app.status === 'PENDING'">
          <button type="button" class="btn-accept" (click)="accept(app)" [disabled]="actioning">Accept</button>
          <button type="button" class="btn-shortlist" (click)="shortlist(app)" [disabled]="actioning">Shortlist</button>
          <button type="button" class="btn-reject" (click)="reject(app)" [disabled]="actioning">Reject</button>
          @if (app.isRead === false) {
            <button type="button" class="btn-mark-read" (click)="markAsRead(app)">Mark read</button>
          }
        </div>
        <div class="app-actions" *ngIf="app.status === 'SHORTLISTED'">
          <button type="button" class="btn-accept" (click)="accept(app)" [disabled]="actioning">Accept</button>
          <button type="button" class="btn-reject" (click)="reject(app)" [disabled]="actioning">Reject</button>
          @if (app.isRead === false) {
            <button type="button" class="btn-mark-read" (click)="markAsRead(app)">Mark read</button>
          }
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Reject with reason -->
@if (rejectModalOpen && rejectApp) {
  <div class="modal-overlay" (click)="closeRejectModal()">
    <div class="modal card" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3 class="modal-title">Reject application</h3>
        <button type="button" class="modal-close" (click)="closeRejectModal()" aria-label="Close">×</button>
      </div>
      <div class="modal-body">
        <p class="modal-text">Optionally add a reason to inform the client.</p>
        <div class="form-group">
          <label for="reject-reason">Reason (optional)</label>
          <textarea id="reject-reason" [(ngModel)]="rejectReason" name="rejectReason" rows="3" placeholder="e.g. Budget does not match our scope..."></textarea>
        </div>
        @if (rejectError) {
          <p class="modal-error" role="alert">{{ rejectError }}</p>
        }
        <div class="modal-actions">
          <button type="button" class="btn-cancel" (click)="closeRejectModal()">Cancel</button>
          <button type="button" class="btn-reject-confirm" (click)="submitReject()" [disabled]="actioning">{{ actioning ? 'Rejecting...' : 'Reject' }}</button>
        </div>
      </div>
    </div>
  </div>
}

<p class="error-msg" *ngIf="errorMessage">{{ errorMessage }}</p>
<p class="loading-msg" *ngIf="loading && !offer">Loading offer...</p>
