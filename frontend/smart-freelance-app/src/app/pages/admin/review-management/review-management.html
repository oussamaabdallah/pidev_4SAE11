<div class="admin-management-page">
  <header class="page-header">
    <h1>Review Management</h1>
    <p class="subtitle">View, search, and manage all platform reviews in one place.</p>
  </header>

  @if (errorMessage) {
    <div class="error-banner" role="alert">{{ errorMessage }}</div>
  }

  @if (stats) {
    <section class="stats-section" aria-label="Review statistics">
      <div class="stats-cards">
        <div class="stat-card stat-card--total">
          <span class="stat-value">{{ stats.totalCount }}</span>
          <span class="stat-label">Total reviews</span>
        </div>
        <div class="stat-card stat-card--avg">
          <span class="stat-value stat-value--stars"><app-star-rating [rating]="roundedAverageRating" [showValue]="true"></app-star-rating></span>
          <span class="stat-label">Average ({{ stats.averageRating | number:'1.1-1' }})</span>
        </div>
        @for (r of [5,4,3,2,1]; track r) {
          <div class="stat-card stat-card--rating">
            <span class="stat-value">{{ stats.countByRating[r] ?? 0 }}</span>
            <span class="stat-label">{{ r }} star(s)</span>
          </div>
        }
      </div>
    </section>
  }

  <section class="content-card">
    <div class="toolbar">
      <div class="toolbar-filters">
        <input
          type="search"
          class="search-input"
          placeholder="Search in comments..."
          [value]="searchTerm"
          (input)="onSearchInput($any($event.target).value)"
        />
        <select class="filter-select" [value]="ratingFilter === null ? '' : ratingFilter" (change)="ratingFilter = $any($event.target).value === '' ? null : +$any($event.target).value; onRatingFilterChange()">
          @for (opt of ratingOptions; track opt.label) {
            <option [value]="opt.value === null ? '' : opt.value">{{ opt.label }}</option>
          }
        </select>
      </div>
      <div class="toolbar-meta">
        <span class="count">{{ totalElements }} review(s)</span>
        <div class="toolbar-actions">
          <button type="button" class="btn-add" (click)="openAdd()">Add review</button>
          <button type="button" class="btn-refresh" (click)="loadReviews(); loadStats()" [disabled]="loading">
            {{ loading ? 'Loadingâ€¦' : 'Refresh' }}
          </button>
        </div>
      </div>
    </div>

    @if (loading && reviews.length === 0) {
      <div class="loading-state">
        <div class="loading-spinner" aria-hidden="true"></div>
        <p class="loading-msg">Loading reviewsâ€¦</p>
      </div>
    } @else if (reviews.length === 0) {
      <div class="empty-state">
        <span class="empty-icon" aria-hidden="true">ðŸ“‹</span>
        <p class="empty-title">No reviews found</p>
        <p class="empty-desc">Try adjusting your search or filters, or add a new review.</p>
      </div>
    } @else {
      <div class="table-section">
        <h2 class="table-section-title">All reviews</h2>
        <div class="table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Reviewer ID</th>
              <th>Reviewee ID</th>
              <th>Project ID</th>
              <th>Rating</th>
              <th>Comment</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (r of reviews; track r.id) {
              <tr>
                <td>{{ r.id }}</td>
                <td>{{ r.reviewerId }}</td>
                <td>{{ r.revieweeId }}</td>
                <td>{{ r.projectId }}</td>
                <td><app-star-rating [rating]="r.rating" [showValue]="true"></app-star-rating></td>
                <td class="comment-cell">{{ (r.comment || 'â€”') | slice:0:60 }}{{ (r.comment && r.comment.length > 60) ? 'â€¦' : '' }}</td>
                <td>{{ r.createdAt | date:'short' }}</td>
                <td class="actions">
                  <button type="button" class="btn-action btn-edit" (click)="openEdit(r)">Edit</button>
                  <button type="button" class="btn-action btn-delete" (click)="openDeleteModal(r)">Delete</button>
                </td>
              </tr>
            }
          </tbody>
        </table>
        </div>
      </div>

      @if (totalPages > 1) {
        <div class="pagination">
          <div class="pagination-size">
            <label for="pageSize">Per page</label>
            <select id="pageSize" [value]="size" (change)="setPageSize(+$any($event.target).value)">
              @for (s of pageSizes; track s) {
                <option [value]="s">{{ s }}</option>
              }
            </select>
          </div>
          <div class="pagination-nav">
            <button type="button" class="btn-page" [disabled]="page === 0" (click)="goToPage(0)">First</button>
            <button type="button" class="btn-page" [disabled]="page === 0" (click)="goToPage(page - 1)">Previous</button>
            <span class="pagination-info">Page {{ page + 1 }} of {{ totalPages }}</span>
            <button type="button" class="btn-page" [disabled]="page >= totalPages - 1" (click)="goToPage(page + 1)">Next</button>
            <button type="button" class="btn-page" [disabled]="page >= totalPages - 1" (click)="goToPage(totalPages - 1)">Last</button>
          </div>
        </div>
      }
    }
  </section>

  @if (addModalOpen) {
    <div class="modal-overlay" (click)="closeAdd()">
      <div class="modal modal--form" (click)="$event.stopPropagation()">
        <h3>Add review</h3>
        <form [formGroup]="addForm" (ngSubmit)="saveAdd()">
          <div class="field">
            <label for="add-reviewerId">Reviewer ID</label>
            <input id="add-reviewerId" type="number" formControlName="reviewerId" min="1" />
            @if (addForm.get('reviewerId')?.invalid && addForm.get('reviewerId')?.touched) {
              <span class="field-error">Required, min 1.</span>
            }
          </div>
          <div class="field">
            <label for="add-revieweeId">Reviewee ID</label>
            <input id="add-revieweeId" type="number" formControlName="revieweeId" min="1" />
            @if (addForm.get('revieweeId')?.invalid && addForm.get('revieweeId')?.touched) {
              <span class="field-error">Required, min 1.</span>
            }
          </div>
          <div class="field">
            <label for="add-projectId">Project ID</label>
            <input id="add-projectId" type="number" formControlName="projectId" min="1" />
            @if (addForm.get('projectId')?.invalid && addForm.get('projectId')?.touched) {
              <span class="field-error">Required, min 1.</span>
            }
          </div>
          <div class="field">
            <label for="add-rating">Rating (1â€“5)</label>
            <input id="add-rating" type="number" formControlName="rating" min="1" max="5" />
            @if (addForm.get('rating')?.invalid && addForm.get('rating')?.touched) {
              <span class="field-error">1â€“5.</span>
            }
          </div>
          <div class="field">
            <label for="add-comment">Comment (optional)</label>
            <textarea id="add-comment" formControlName="comment" rows="3" maxlength="1000"></textarea>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn-secondary" (click)="closeAdd()" [disabled]="adding">Cancel</button>
            <button type="submit" class="btn-primary" [disabled]="addForm.invalid || adding">
              {{ adding ? 'Creatingâ€¦' : 'Create review' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  @if (editingReview) {
    <div class="modal-overlay" (click)="closeEdit()">
      <div class="modal modal--form" (click)="$event.stopPropagation()">
        <h3>Edit review</h3>
        <p class="modal-hint">ID: {{ editingReview.id }}</p>
        <form [formGroup]="editForm" (ngSubmit)="saveEdit()">
          <div class="field">
            <label for="edit-reviewerId">Reviewer ID</label>
            <input id="edit-reviewerId" type="number" formControlName="reviewerId" min="1" />
            @if (editForm.get('reviewerId')?.invalid && editForm.get('reviewerId')?.touched) {
              <span class="field-error">Required, min 1.</span>
            }
          </div>
          <div class="field">
            <label for="edit-revieweeId">Reviewee ID</label>
            <input id="edit-revieweeId" type="number" formControlName="revieweeId" min="1" />
            @if (editForm.get('revieweeId')?.invalid && editForm.get('revieweeId')?.touched) {
              <span class="field-error">Required, min 1.</span>
            }
          </div>
          <div class="field">
            <label for="edit-projectId">Project ID</label>
            <input id="edit-projectId" type="number" formControlName="projectId" min="1" />
            @if (editForm.get('projectId')?.invalid && editForm.get('projectId')?.touched) {
              <span class="field-error">Required, min 1.</span>
            }
          </div>
          <div class="field">
            <label for="edit-rating">Rating (1â€“5)</label>
            <input id="edit-rating" type="number" formControlName="rating" min="1" max="5" />
            @if (editForm.get('rating')?.invalid && editForm.get('rating')?.touched) {
              <span class="field-error">1â€“5.</span>
            }
          </div>
          <div class="field">
            <label for="edit-comment">Comment (optional)</label>
            <textarea id="edit-comment" formControlName="comment" rows="3" maxlength="1000"></textarea>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn-secondary" (click)="closeEdit()" [disabled]="saving">Cancel</button>
            <button type="submit" class="btn-primary" [disabled]="editForm.invalid || saving">
              {{ saving ? 'Savingâ€¦' : 'Save' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  @if (reviewToDelete) {
    <div class="modal-overlay" (click)="closeDeleteModal()">
      <div class="modal modal--confirm" (click)="$event.stopPropagation()">
        <h3>Delete review</h3>
        <p class="modal-message">
          Are you sure you want to delete this review (ID {{ reviewToDelete.id }})? This action cannot be undone.
        </p>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeDeleteModal()" [disabled]="deleting">Cancel</button>
          <button type="button" class="btn-danger" (click)="doDelete()" [disabled]="deleting">
            {{ deleting ? 'Deletingâ€¦' : 'Delete' }}
          </button>
        </div>
      </div>
    </div>
  }
</div>
